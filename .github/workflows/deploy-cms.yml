name: Deploy CMS (Advanced)

on:
  push:
    branches: [ "main" ]
    paths:
      - "cms/upskillwaycrm-feature-whatsapp-email-improvements/**"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Build CMS
        run: |
          cd cms/upskillwaycrm-feature-whatsapp-email-improvements
          npm install
          npm run build
          tar -czf cms-dist.tar.gz dist

      - name: Upload and Deploy on EC2
        run: |
          scp -o StrictHostKeyChecking=no cms/upskillwaycrm-feature-whatsapp-email-improvements/cms-dist.tar.gz \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/cms-dist.tar.gz

          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          
          set -e
          CMS_PATH="/var/www/cms"

          echo "ðŸ“¦ Extracting CMS bundleâ€¦"
          sudo rm -rf $CMS_PATH/*
          sudo tar -xzf /tmp/cms-dist.tar.gz -C $CMS_PATH

          echo "ðŸ”„ Restarting NGINXâ€¦"
          sudo systemctl reload nginx

          echo "ðŸ§¹ Cleaning temporary filesâ€¦"
          rm /tmp/cms-dist.tar.gz

          echo "ðŸ“œ Deployment logged"
          echo "CMS deployed at $(date)" >> ~/deploy-log-cms.txt

          EOF
