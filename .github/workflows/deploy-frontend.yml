name: Deploy Frontend (Advanced)

on:
  push:
    branches: [ "main" ]
    paths:
      - "frontend/upSkillWayFrontend-main/**"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build production frontend
        run: |
          cd frontend/upSkillWayFrontend-main
          npm install
          npm run build
          tar -czf frontend-dist.tar.gz dist

      - name: Upload to EC2 and activate
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "frontend/upSkillWayFrontend-main/frontend-dist.tar.gz"
          target: "/tmp/"

      - name: Deploy to NGINX
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'

          set -e
          FRONTEND_PATH="/var/www/upskillway"

          echo "ðŸ“¦ Deploying new frontendâ€¦"
          sudo rm -rf $FRONTEND_PATH/*
          sudo tar -xzf /tmp/frontend-dist.tar.gz -C $FRONTEND_PATH

          echo "â™» Reloading NGINXâ€¦"
          sudo systemctl reload nginx

          echo "ðŸ§¹ Cleaning upâ€¦"
          rm /tmp/frontend-dist.tar.gz

          echo "ðŸ“œ Frontend deployed at $(date)" >> ~/deploy-log-frontend.txt

          EOF
