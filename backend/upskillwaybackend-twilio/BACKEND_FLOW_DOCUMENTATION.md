# UpSkillWay Backend - Complete Flow Documentation

## ğŸ“‹ Table of Contents
1. [Application Architecture Overview](#application-architecture-overview)
2. [Application Startup Flow](#application-startup-flow)
3. [Request Flow Pipeline](#request-flow-pipeline)
4. [Authentication & Authorization Flow](#authentication--authorization-flow)
5. [API Request Processing Flow](#api-request-processing-flow)
6. [Database Layer Flow](#database-layer-flow)
7. [Error Handling Flow](#error-handling-flow)
8. [Response Flow](#response-flow)
9. [External Service Integration](#external-service-integration)

---

## ğŸ—ï¸ Application Architecture Overview

### Technology Stack
- **Runtime**: Node.js with TypeScript
- **Framework**: Express.js
- **ORM**: Prisma
- **Database**: PostgreSQL
- **Authentication**: JWT (JSON Web Tokens)
- **Queue System**: BullMQ with Redis (optional)
- **Email Service**: Brevo API
- **WhatsApp Service**: WAPI (WhatsApp API)
- **Logging**: Pino
- **Documentation**: Swagger/OpenAPI

### Project Structure
```
src/
â”œâ”€â”€ server.ts              # Application entry point
â”œâ”€â”€ app.ts                 # Express app configuration
â”œâ”€â”€ config/                # Configuration files
â”‚   â”œâ”€â”€ index.ts          # Main config
â”‚   â”œâ”€â”€ database.ts       # Prisma client
â”‚   â”œâ”€â”€ jwt.ts            # JWT utilities
â”‚   â””â”€â”€ admin.ts          # Admin credentials
â”œâ”€â”€ middlewares/           # Express middlewares
â”‚   â”œâ”€â”€ auth.ts           # Authentication & authorization
â”‚   â”œâ”€â”€ errorHandler.ts   # Error handling
â”‚   â”œâ”€â”€ security.ts       # Security (CORS, Helmet)
â”‚   â”œâ”€â”€ simpleRateLimiter.ts  # Rate limiting
â”‚   â”œâ”€â”€ loadBalancer.ts   # Load balancing & circuit breaker
â”‚   â””â”€â”€ performanceMonitor.ts # Performance monitoring
â”œâ”€â”€ routes/                # API route definitions
â”œâ”€â”€ controllers/           # Request handlers
â”œâ”€â”€ services/              # Business logic
â”œâ”€â”€ validators/            # Input validation schemas
â””â”€â”€ utils/                # Utility functions
    â”œâ”€â”€ logger.ts         # Logging utility
    â”œâ”€â”€ response.ts       # Response helpers
    â”œâ”€â”€ errors.ts         # Custom error classes
    â”œâ”€â”€ emailQueue.ts     # Email queue manager
    â”œâ”€â”€ brevoClient.ts    # Brevo email client
    â””â”€â”€ wapiClient.ts     # WhatsApp API client
```

---

## ğŸš€ Application Startup Flow

### 1. Server Initialization (`server.ts`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Load Environment Variables          â”‚
â”‚     - DATABASE_URL                       â”‚
â”‚     - JWT_SECRET                         â”‚
â”‚     - PORT                               â”‚
â”‚     - REDIS_HOST, REDIS_PORT            â”‚
â”‚     - BREVO_API_KEY                      â”‚
â”‚     - WAPI credentials                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Validate Configuration              â”‚
â”‚     - Check required env variables      â”‚
â”‚     - Validate database connection       â”‚
â”‚     - Exit if validation fails          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Initialize Express App (app.ts)     â”‚
â”‚     - Create Express instance            â”‚
â”‚     - Configure middlewares              â”‚
â”‚     - Register routes                    â”‚
â”‚     - Setup error handlers              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Start HTTP Server                   â”‚
â”‚     - Listen on configured PORT         â”‚
â”‚     - Log startup information           â”‚
â”‚     - Setup graceful shutdown handlers â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Initialize Background Services      â”‚
â”‚     - Email Queue Manager (Redis)        â”‚
â”‚     - Performance Monitor               â”‚
â”‚     - Load Balancer Circuit Breaker    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Express App Configuration (`app.ts`)

**Middleware Stack (Order Matters!):**

```javascript
1. Security Middleware
   â”œâ”€â”€ Helmet (Security headers)
   â””â”€â”€ CORS (Cross-origin resource sharing)

2. Performance Monitoring
   â””â”€â”€ Track all requests for metrics

3. Load Balancing & Circuit Breaker
   â”œâ”€â”€ Health checks
   â”œâ”€â”€ Circuit breaker pattern
   â””â”€â”€ Graceful degradation

4. Intelligent Throttling
   â””â”€â”€ Dynamic rate limiting based on server load

5. Rate Limiting (Progressive Protection)
   â”œâ”€â”€ Burst Protection (500 req/min)
   â””â”€â”€ General Rate Limit (5000 req/15min)

6. Timeout Handler
   â””â”€â”€ 30-second request timeout

7. HTTP Logging
   â””â”€â”€ Request/response logging with Pino

8. Body Parsing
   â”œâ”€â”€ JSON (10MB limit)
   â””â”€â”€ URL-encoded (10MB limit)

9. API Routes
   â””â”€â”€ Mounted with specific rate limits

10. Error Handlers (Last!)
    â”œâ”€â”€ Validation Error Handler
    â”œâ”€â”€ Database Error Handler
    â”œâ”€â”€ Not Found Handler
    â””â”€â”€ General Error Handler
```

---

## ğŸ”„ Request Flow Pipeline

### Complete Request Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENT REQUEST                            â”‚
â”‚  POST /api/v1/courses                                       â”‚
â”‚  Headers: { Authorization: "Bearer <token>", ... }          â”‚
â”‚  Body: { title: "...", description: "...", ... }          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Security Middleware                                â”‚
â”‚  â”œâ”€â”€ Helmet: Add security headers                           â”‚
â”‚  â””â”€â”€ CORS: Validate origin                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Performance Monitoring                            â”‚
â”‚  â””â”€â”€ Start timer, track request metrics                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Load Balancer & Circuit Breaker                    â”‚
â”‚  â”œâ”€â”€ Check circuit breaker state                            â”‚
â”‚  â”œâ”€â”€ Monitor server health                                  â”‚
â”‚  â””â”€â”€ Reject if circuit is OPEN                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: Intelligent Throttling                            â”‚
â”‚  â””â”€â”€ Adjust rate limits based on server load                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: Rate Limiting                                     â”‚
â”‚  â”œâ”€â”€ Burst Protection: 500 req/min                         â”‚
â”‚  â””â”€â”€ General Rate Limit: 5000 req/15min                     â”‚
â”‚  â””â”€â”€ Route-specific: CMS Rate Limit (100 req/min)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: Timeout Handler                                    â”‚
â”‚  â””â”€â”€ Set 30-second timeout                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: HTTP Logger                                       â”‚
â”‚  â””â”€â”€ Log request details (method, URL, IP, etc.)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 8: Body Parser                                       â”‚
â”‚  â”œâ”€â”€ Parse JSON body (max 10MB)                            â”‚
â”‚  â””â”€â”€ Attach to req.body                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 9: Route Matching                                    â”‚
â”‚  â””â”€â”€ Match: /api/v1/courses â†’ cmsRoutes                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 10: Authentication Middleware                        â”‚
â”‚  â”œâ”€â”€ Extract token from Authorization header               â”‚
â”‚  â”œâ”€â”€ Verify JWT token                                      â”‚
â”‚  â”œâ”€â”€ Check token type (access token)                       â”‚
â”‚  â””â”€â”€ Attach user data to req.user                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 11: Authorization Middleware                         â”‚
â”‚  â””â”€â”€ Check if user role is 'admin'                         â”‚
â”‚  â””â”€â”€ Reject if unauthorized                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 12: Input Validation                                 â”‚
â”‚  â”œâ”€â”€ Validate request body against schema                  â”‚
â”‚  â”œâ”€â”€ Check required fields                                 â”‚
â”‚  â”œâ”€â”€ Validate data types                                   â”‚
â”‚  â””â”€â”€ Reject if validation fails                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 13: Controller                                       â”‚
â”‚  â””â”€â”€ createCourseController(req, res)                       â”‚
â”‚      â”œâ”€â”€ Extract data from req.body                        â”‚
â”‚      â”œâ”€â”€ Extract user from req.user                        â”‚
â”‚      â””â”€â”€ Call service layer                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 14: Service Layer                                    â”‚
â”‚  â””â”€â”€ createCourse(data, userId)                           â”‚
â”‚      â”œâ”€â”€ Business logic validation                         â”‚
â”‚      â”œâ”€â”€ Data transformation                               â”‚
â”‚      â””â”€â”€ Call database layer                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 15: Database Layer (Prisma)                          â”‚
â”‚  â””â”€â”€ prisma.course.create({ ... })                         â”‚
â”‚      â”œâ”€â”€ Execute SQL query                                â”‚
â”‚      â”œâ”€â”€ Return created record                            â”‚
â”‚      â””â”€â”€ Handle database errors                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 16: Response Flow                                    â”‚
â”‚  â”œâ”€â”€ Service returns data                                  â”‚
â”‚  â”œâ”€â”€ Controller formats response                           â”‚
â”‚  â””â”€â”€ Send success response                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENT RESPONSE                          â”‚
â”‚  Status: 201 Created                                       â”‚
â”‚  Body: {                                                    â”‚
â”‚    success: true,                                          â”‚
â”‚    message: "Course created successfully",                 â”‚
â”‚    data: { id: "...", title: "...", ... }                 â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Authentication & Authorization Flow

### Login Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/v1/auth/login                  â”‚
â”‚  Body: { email, password }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Rate Limiting Check                  â”‚
â”‚     â””â”€â”€ Auth Rate Limit: 10 attempts/15minâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Input Validation                     â”‚
â”‚     â””â”€â”€ Validate email & password format â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Authentication Service               â”‚
â”‚     â”œâ”€â”€ Find user by email               â”‚
â”‚     â”œâ”€â”€ Verify password (bcrypt)         â”‚
â”‚     â”œâ”€â”€ Check if user is active          â”‚
â”‚     â””â”€â”€ Generate JWT tokens              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Token Generation                     â”‚
â”‚     â”œâ”€â”€ Access Token (15min expiry)      â”‚
â”‚     â”‚   â””â”€â”€ Contains: id, email, role     â”‚
â”‚     â””â”€â”€ Refresh Token (7 days expiry)    â”‚
â”‚         â””â”€â”€ Store in database            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Response                             â”‚
â”‚     {                                    â”‚
â”‚       accessToken: "...",                â”‚
â”‚       refreshToken: "...",               â”‚
â”‚       user: { id, email, name, role }    â”‚
â”‚     }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Protected Route Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Request with Authorization Header        â”‚
â”‚  Authorization: Bearer <access_token>     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Authentication Middleware            â”‚
â”‚     â”œâ”€â”€ Extract token from header        â”‚
â”‚     â”œâ”€â”€ Verify JWT signature             â”‚
â”‚     â”œâ”€â”€ Check token expiration          â”‚
â”‚     â”œâ”€â”€ Verify token type (access)       â”‚
â”‚     â””â”€â”€ Attach user to req.user          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Authorization Middleware            â”‚
â”‚     â”œâ”€â”€ Check req.user exists            â”‚
â”‚     â”œâ”€â”€ Verify user role                 â”‚
â”‚     â””â”€â”€ Check role permissions           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Route Handler                       â”‚
â”‚     â””â”€â”€ Process request with user contextâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Token Refresh Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/v1/auth/refresh                â”‚
â”‚  Body: { refreshToken: "..." }            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Validate Refresh Token               â”‚
â”‚     â”œâ”€â”€ Verify signature                 â”‚
â”‚     â”œâ”€â”€ Check expiration                â”‚
â”‚     â””â”€â”€ Verify token type (refresh)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Check Database                       â”‚
â”‚     â”œâ”€â”€ Find token in refresh_tokens      â”‚
â”‚     â”œâ”€â”€ Check if revoked                 â”‚
â”‚     â””â”€â”€ Verify expiration                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Generate New Tokens                  â”‚
â”‚     â”œâ”€â”€ New Access Token (15min)         â”‚
â”‚     â””â”€â”€ New Refresh Token (7 days)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Update Database                      â”‚
â”‚     â”œâ”€â”€ Revoke old refresh token         â”‚
â”‚     â””â”€â”€ Store new refresh token          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Response                             â”‚
â”‚     {                                    â”‚
â”‚       accessToken: "new_token",          â”‚
â”‚       refreshToken: "new_refresh_token"  â”‚
â”‚     }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¡ API Request Processing Flow

### Example: Creating a Course

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ROUTE: POST /api/v1/courses                                â”‚
â”‚  Route File: src/routes/cms.ts                              â”‚
â”‚  Route Definition:                                          â”‚
â”‚    router.post('/courses',                                  â”‚
â”‚      authenticate,        // Auth middleware                â”‚
â”‚      requireAdmin,        // Role check                     â”‚
â”‚      validateSchemaMiddleware(courseSchema), // Validation  â”‚
â”‚      createCourseController  // Controller                  â”‚
â”‚    )                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONTROLLER: src/controllers/cmsController.ts               â”‚
â”‚                                                              â”‚
â”‚  export const createCourseController = asyncHandler(         â”‚
â”‚    async (req: Request, res: Response) => {                 â”‚
â”‚      const courseData = req.body as CourseInput;            â”‚
â”‚      const userId = req.user!.id;                           â”‚
â”‚                                                              â”‚
â”‚      const course = await createCourse(courseData, userId); â”‚
â”‚                                                              â”‚
â”‚      sendSuccess(res, 'Course created successfully',        â”‚
â”‚        course, 201);                                        â”‚
â”‚    }                                                         â”‚
â”‚  );                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVICE: src/services/cmsService.ts                        â”‚
â”‚                                                              â”‚
â”‚  export const createCourse = async (                        â”‚
â”‚    courseData: CourseInput,                                 â”‚
â”‚    userId: string                                           â”‚
â”‚  ) => {                                                     â”‚
â”‚    // 1. Business logic validation                          â”‚
â”‚    // 2. Data transformation                                â”‚
â”‚    // 3. Database operation                                 â”‚
â”‚                                                              â”‚
â”‚    const course = await prisma.course.create({              â”‚
â”‚      data: {                                                â”‚
â”‚        ...courseData,                                       â”‚
â”‚        createdBy: userId,                                   â”‚
â”‚        tags: courseData.tags || [],                         â”‚
â”‚        deliveryModes: courseData.deliveryModes || [],      â”‚
â”‚      },                                                     â”‚
â”‚      include: { creator: { select: {...} } }               â”‚
â”‚    });                                                      â”‚
â”‚                                                              â”‚
â”‚    return course;                                           â”‚
â”‚  };                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE: Prisma ORM â†’ PostgreSQL                          â”‚
â”‚                                                              â”‚
â”‚  Prisma generates and executes:                            â”‚
â”‚  INSERT INTO courses (                                       â”‚
â”‚    id, title, slug, description, ...                        â”‚
â”‚  ) VALUES (                                                 â”‚
â”‚    uuid_generate_v4(), '...', '...', ...                    â”‚
â”‚  ) RETURNING *;                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RESPONSE: Formatted JSON Response                           â”‚
â”‚                                                              â”‚
â”‚  {                                                          â”‚
â”‚    "success": true,                                         â”‚
â”‚    "message": "Course created successfully",                â”‚
â”‚    "data": {                                                â”‚
â”‚      "id": "uuid",                                          â”‚
â”‚      "title": "...",                                        â”‚
â”‚      "slug": "...",                                         â”‚
â”‚      "creator": { ... },                                    â”‚
â”‚      ...                                                    â”‚
â”‚    },                                                       â”‚
â”‚    "timestamp": "2025-11-13T..."                           â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Database Layer Flow

### Prisma Client Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prisma Schema (schema.prisma)          â”‚
â”‚  â”œâ”€â”€ Models (User, Course, Blog, ...)    â”‚
â”‚  â”œâ”€â”€ Relations                           â”‚
â”‚  â””â”€â”€ Enums                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prisma Generate                         â”‚
â”‚  â””â”€â”€ Generates TypeScript types           â”‚
â”‚  â””â”€â”€ Creates Prisma Client                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prisma Client (src/config/database.ts)  â”‚
â”‚  â””â”€â”€ Singleton instance                  â”‚
â”‚  â””â”€â”€ Connection pooling                  â”‚
â”‚  â””â”€â”€ Query logging (dev mode)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service Layer                           â”‚
â”‚  â””â”€â”€ Uses prisma.course.findMany()       â”‚
â”‚  â””â”€â”€ Type-safe queries                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL Database                     â”‚
â”‚  â””â”€â”€ Executes SQL queries                â”‚
â”‚  â””â”€â”€ Returns results                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Query Flow

```
Service Layer
    â”‚
    â”œâ”€â†’ prisma.course.findMany({ ... })
    â”‚       â”‚
    â”‚       â”œâ”€â†’ Prisma Client
    â”‚       â”‚       â”‚
    â”‚       â”‚       â”œâ”€â†’ Validates query
    â”‚       â”‚       â”œâ”€â†’ Generates SQL
    â”‚       â”‚       â””â”€â†’ Type checking
    â”‚       â”‚
    â”‚       â””â”€â†’ PostgreSQL
    â”‚               â”‚
    â”‚               â”œâ”€â†’ Execute SQL
    â”‚               â”œâ”€â†’ Return results
    â”‚               â””â”€â†’ Connection pooling
    â”‚
    â””â”€â†’ Returns typed results
```

---

## âš ï¸ Error Handling Flow

### Error Hierarchy

```
Error
  â””â”€â”€ AppError (Base class)
      â”œâ”€â”€ AuthenticationError (401)
      â”œâ”€â”€ AuthorizationError (403)
      â”œâ”€â”€ NotFoundError (404)
      â”œâ”€â”€ ValidationError (400)
      â”œâ”€â”€ ConflictError (409)
      â”œâ”€â”€ RateLimitError (429)
      â”œâ”€â”€ ServerOverloadError (503)
      â”œâ”€â”€ CircuitBreakerError (503)
      â””â”€â”€ InternalServerError (500)
```

### Error Handling Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Error Occurs in Service/Controller     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Error is Caught by asyncHandler        â”‚
â”‚  â””â”€â”€ Wraps async functions              â”‚
â”‚  â””â”€â”€ Catches promise rejections         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Error Passed to Error Middleware       â”‚
â”‚  (Order matters!)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Validation Error Handler            â”‚
â”‚     â””â”€â”€ Handles Zod/Validation errors   â”‚
â”‚     â””â”€â”€ Returns 400 with details        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ (if not validation error)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Database Error Handler              â”‚
â”‚     â””â”€â”€ Handles Prisma errors           â”‚
â”‚     â””â”€â”€ Handles connection errors        â”‚
â”‚     â””â”€â”€ Returns 503 with retry info     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ (if not database error)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Not Found Handler                   â”‚
â”‚     â””â”€â”€ Handles 404 routes              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ (if not 404)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. General Error Handler               â”‚
â”‚     â”œâ”€â”€ Log error with context          â”‚
â”‚     â”œâ”€â”€ Determine error type            â”‚
â”‚     â”œâ”€â”€ Format error response            â”‚
â”‚     â””â”€â”€ Send appropriate status code     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Error Response Sent to Client          â”‚
â”‚  {                                        â”‚
â”‚    success: false,                       â”‚
â”‚    message: "Error message",             â”‚
â”‚    error: "ERROR_TYPE",                  â”‚
â”‚    retryAfter: 30,  // if retryable      â”‚
â”‚    timestamp: "..."                      â”‚
â”‚  }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Error Response Examples

**Authentication Error (401):**
```json
{
  "success": false,
  "message": "Authentication failed",
  "error": "AuthenticationError",
  "timestamp": "2025-11-13T..."
}
```

**Rate Limit Error (429):**
```json
{
  "success": false,
  "message": "Rate limit exceeded",
  "error": "RATE_LIMIT_EXCEEDED",
  "retryAfter": 60,
  "retryable": true,
  "timestamp": "2025-11-13T..."
}
```

**Database Error (503):**
```json
{
  "success": false,
  "message": "Database operation failed",
  "error": "DATABASE_UNAVAILABLE",
  "retryAfter": 30,
  "retryable": true,
  "timestamp": "2025-11-13T..."
}
```

---

## ğŸ“¤ Response Flow

### Success Response Format

```typescript
// Standard Response
{
  success: true,
  message: "Operation successful",
  data: { ... },
  timestamp: "2025-11-13T..."
}

// Paginated Response
{
  success: true,
  message: "Data retrieved successfully",
  data: [ ... ],
  pagination: {
    page: 1,
    limit: 10,
    total: 100,
    totalPages: 10,
    hasNext: true,
    hasPrev: false
  },
  timestamp: "2025-11-13T..."
}
```

### Response Utilities (`src/utils/response.ts`)

```typescript
// Success response
sendSuccess(res, message, data, statusCode = 200)

// Paginated response
sendPaginated(res, message, data, pagination, statusCode = 200)

// Error response
sendError(res, message, statusCode, error)
```

---

## ğŸ”Œ External Service Integration

### Email Service Flow (Brevo)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Email Service Request                   â”‚
â”‚  POST /api/v1/email/send                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Email Controller                        â”‚
â”‚  â””â”€â”€ Validates request                   â”‚
â”‚  â””â”€â”€ Calls email service                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Email Service                           â”‚
â”‚  â””â”€â”€ Prepares email data                 â”‚
â”‚  â””â”€â”€ Adds to email queue                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Email Queue Manager (BullMQ)           â”‚
â”‚  â”œâ”€â”€ Redis Available?                   â”‚
â”‚  â”‚   â”œâ”€â”€ Yes â†’ Add to queue              â”‚
â”‚  â”‚   â””â”€â”€ No â†’ Send directly              â”‚
â”‚  â””â”€â”€ Worker processes job                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Brevo Client                            â”‚
â”‚  â”œâ”€â”€ API Method: sendTransactionalEmail  â”‚
â”‚  â””â”€â”€ SMTP Method: sendSmtpEmail         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Brevo API                               â”‚
â”‚  â””â”€â”€ Sends email                         â”‚
â”‚  â””â”€â”€ Returns message ID                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Log Email                               â”‚
â”‚  â””â”€â”€ Store in email_logs table          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WhatsApp Service Flow (WAPI)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsApp Request                        â”‚
â”‚  POST /api/v1/whatsapp/send              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsApp Controller                     â”‚
â”‚  â””â”€â”€ Validates request                   â”‚
â”‚  â””â”€â”€ Calls WhatsApp service             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsApp Service                        â”‚
â”‚  â”œâ”€â”€ Prepares message payload            â”‚
â”‚  â”œâ”€â”€ Calls WAPI client                   â”‚
â”‚  â””â”€â”€ Handles rate limiting               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WAPI Client                             â”‚
â”‚  â”œâ”€â”€ Formats message for WAPI           â”‚
â”‚  â”œâ”€â”€ Adds authentication headers         â”‚
â”‚  â””â”€â”€ Makes HTTP request                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WAPI API                                â”‚
â”‚  â””â”€â”€ Sends WhatsApp message             â”‚
â”‚  â””â”€â”€ Returns message ID                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Log Message                             â”‚
â”‚  â””â”€â”€ Store in whatsapp_messages table    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š API Routes Overview

### Route Structure

```
/api/v1/
â”œâ”€â”€ /auth                    # Authentication
â”‚   â”œâ”€â”€ POST /login          # Sales login
â”‚   â”œâ”€â”€ POST /admin/login    # Admin login
â”‚   â”œâ”€â”€ POST /refresh        # Refresh token
â”‚   â”œâ”€â”€ POST /logout         # Logout
â”‚   â””â”€â”€ GET /profile         # Get user profile
â”‚
â”œâ”€â”€ /admin                    # Admin operations
â”‚   â””â”€â”€ POST /login          # Admin login (legacy)
â”‚
â”œâ”€â”€ /users                    # User management (admin only)
â”‚   â”œâ”€â”€ GET /                # List users
â”‚   â”œâ”€â”€ POST /               # Create user
â”‚   â”œâ”€â”€ GET /:id             # Get user
â”‚   â”œâ”€â”€ PUT /:id              # Update user
â”‚   â””â”€â”€ DELETE /:id          # Delete user
â”‚
â”œâ”€â”€ /cms                      # Content Management
â”‚   â”œâ”€â”€ /blogs               # Blog CRUD
â”‚   â”œâ”€â”€ /videos              # Video CRUD
â”‚   â”œâ”€â”€ /faqs                # FAQ CRUD
â”‚   â”œâ”€â”€ /testimonials        # Testimonial CRUD
â”‚   â”œâ”€â”€ /courses             # Course CRUD
â”‚   â”œâ”€â”€ /ebooks              # Ebook CRUD
â”‚   â”œâ”€â”€ /study-abroad        # Study Abroad CRUD
â”‚   â”œâ”€â”€ /short-courses       # Short Course CRUD
â”‚   â””â”€â”€ /certified-courses   # Certified Course CRUD
â”‚
â”œâ”€â”€ /leads                    # Lead Management
â”‚   â”œâ”€â”€ POST /               # Create lead (public)
â”‚   â”œâ”€â”€ GET /                # List leads (auth)
â”‚   â”œâ”€â”€ GET /:id             # Get lead
â”‚   â””â”€â”€ PUT /:id             # Update lead
â”‚
â”œâ”€â”€ /crm                      # CRM Operations
â”‚   â””â”€â”€ /leads               # Lead management
â”‚
â”œâ”€â”€ /colleges                 # College Management
â”‚   â”œâ”€â”€ GET /                # List colleges
â”‚   â”œâ”€â”€ POST /               # Create college
â”‚   â””â”€â”€ GET /:id             # Get college
â”‚
â”œâ”€â”€ /trainers                 # Trainer Management
â”‚   â”œâ”€â”€ GET /                # List trainers
â”‚   â”œâ”€â”€ POST /               # Create trainer
â”‚   â””â”€â”€ GET /:id             # Get trainer
â”‚
â”œâ”€â”€ /trainings                # Training Management
â”‚   â”œâ”€â”€ GET /                # List trainings
â”‚   â””â”€â”€ POST /               # Create training
â”‚
â”œâ”€â”€ /trainer-bookings         # Trainer Booking
â”‚   â”œâ”€â”€ GET /                # List bookings
â”‚   â””â”€â”€ POST /               # Create booking
â”‚
â”œâ”€â”€ /whatsapp                 # WhatsApp Messaging
â”‚   â”œâ”€â”€ POST /send           # Send message
â”‚   â””â”€â”€ GET /logs            # Message logs
â”‚
â”œâ”€â”€ /email                    # Email Service
â”‚   â”œâ”€â”€ POST /send           # Send email
â”‚   â”œâ”€â”€ POST /campaign       # Create campaign
â”‚   â””â”€â”€ GET /queue/stats     # Queue statistics
â”‚
â””â”€â”€ /dashboard                # Dashboard Data
    â””â”€â”€ GET /stats           # Dashboard statistics
```

---

## ğŸ”’ Security Features

### 1. Authentication
- JWT-based authentication
- Access tokens (15min expiry)
- Refresh tokens (7 days expiry)
- Token revocation support

### 2. Authorization
- Role-based access control (RBAC)
- Admin and Sales roles
- Route-level permission checks

### 3. Rate Limiting
- Multiple layers of rate limiting
- IP-based limiting
- Route-specific limits
- Dynamic throttling based on server load

### 4. Security Headers
- Helmet.js for security headers
- CORS configuration
- Request size limits (10MB)

### 5. Input Validation
- Zod schema validation
- Type-safe validation
- Sanitization of inputs

---

## ğŸ“ˆ Performance Features

### 1. Monitoring
- Request/response logging
- Performance metrics
- Error tracking
- Uptime monitoring

### 2. Load Management
- Circuit breaker pattern
- Graceful degradation
- Intelligent throttling
- Health checks

### 3. Database
- Connection pooling (Prisma)
- Query optimization
- Indexed fields

### 4. Caching
- Redis for email queues (optional)
- In-memory rate limiting

---

## ğŸ§ª Testing

### Test Structure
```
src/tests/
â”œâ”€â”€ setup.ts              # Test configuration
â”œâ”€â”€ auth.test.ts          # Authentication tests
â””â”€â”€ health.test.ts        # Health check tests
```

### Running Tests
```bash
npm test                  # Run all tests
npm run test:watch        # Watch mode
npm run test:coverage     # Coverage report
```

---

## ğŸ“ Logging

### Log Levels
- `error`: Errors and exceptions
- `warn`: Warnings
- `info`: Informational messages
- `debug`: Debug information (dev only)

### Log Format
```json
{
  "level": "info",
  "time": 1699876543210,
  "msg": "Request completed",
  "method": "POST",
  "url": "/api/v1/courses",
  "statusCode": 201,
  "responseTime": 45
}
```

---

## ğŸš€ Deployment Considerations

### Environment Variables
- `DATABASE_URL`: PostgreSQL connection string
- `JWT_SECRET`: JWT signing secret
- `PORT`: Server port (default: 3000)
- `NODE_ENV`: Environment (development/production)
- `REDIS_HOST`, `REDIS_PORT`: Redis configuration
- `BREVO_API_KEY`: Brevo email API key
- `WAPI_*`: WhatsApp API credentials

### Health Checks
- `/health`: Basic health check
- `/health/detailed`: Detailed health information
- `/ready`: Readiness probe
- `/live`: Liveness probe

### Graceful Shutdown
- Handles SIGTERM and SIGINT
- Closes server connections
- Cleans up resources
- 10-second timeout for forced shutdown

---

## ğŸ“š Additional Resources

- **API Documentation**: `http://localhost:3000/api-docs`
- **Swagger JSON**: `http://localhost:3000/api-docs.json`
- **Health Check**: `http://localhost:3000/health`
- **Metrics**: `http://localhost:3000/metrics`

---

## ğŸ”„ Summary: Complete Request Lifecycle

```
1. Client sends HTTP request
   â†“
2. Security middleware (Helmet, CORS)
   â†“
3. Performance monitoring starts
   â†“
4. Load balancer & circuit breaker check
   â†“
5. Rate limiting validation
   â†“
6. Request timeout setup
   â†“
7. Request logging
   â†“
8. Body parsing
   â†“
9. Route matching
   â†“
10. Authentication (JWT verification)
    â†“
11. Authorization (Role check)
    â†“
12. Input validation (Zod schema)
    â†“
13. Controller (Request handler)
    â†“
14. Service (Business logic)
    â†“
15. Database (Prisma â†’ PostgreSQL)
    â†“
16. Response formatting
    â†“
17. Response logging
    â†“
18. Client receives response
```

---

**Document Version**: 1.0  
**Last Updated**: November 13, 2025  
**Maintained By**: UpSkillWay Development Team

