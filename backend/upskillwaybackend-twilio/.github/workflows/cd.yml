name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [ main, master ]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate Prisma Client
      run: npx prisma generate

    - name: Build application
      run: npm run build

    - name: Deploy to staging
      run: |
        echo "üöÄ Deploying to staging environment..."
        echo "Build completed successfully"
        # Add your staging deployment commands here
        # Examples:
        # - Deploy to Heroku: git push heroku main
        # - Deploy to AWS: aws s3 sync dist/ s3://your-bucket
        # - Deploy to DigitalOcean: doctl apps create-deployment $APP_ID
        # - Deploy via SSH: rsync -avz dist/ user@server:/path/to/app
        
    - name: Run database migrations on staging
      run: |
        echo "üìä Running database migrations on staging..."
        # npx prisma migrate deploy
      # env:
      #   DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}

    - name: Health check staging
      run: |
        echo "üè• Performing health check on staging..."
        sleep 5  # Wait for deployment to complete
        # curl -f ${{ secrets.STAGING_URL }}/health || exit 1

    - name: Notify staging deployment
      run: |
        echo "‚úÖ Staging deployment completed successfully!"

  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate Prisma Client
      run: npx prisma generate

    - name: Build application
      run: npm run build

    - name: Deploy to production
      run: |
        echo "üöÄ Deploying to production environment..."
        echo "Build completed successfully"
        # Add your production deployment commands here
        
    - name: Run database migrations on production
      run: |
        echo "üìä Running database migrations on production..."
        # npx prisma migrate deploy
      # env:
      #   DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

    - name: Health check production
      run: |
        echo "üè• Performing health check on production..."
        sleep 5  # Wait for deployment to complete
        # curl -f ${{ secrets.PRODUCTION_URL }}/health || exit 1

    - name: Notify deployment success
      run: |
        echo "üéâ Production deployment completed successfully!"